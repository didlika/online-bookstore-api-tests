name: API Tests CI/CD

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      base_url:
        description: 'API Base URL'
        required: false
        default: 'https://fakerestapi.azurewebsites.net/api/v1'

env:
  BASE_URL: https://fakerestapi.azurewebsites.net/api/v1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Build and run tests
        continue-on-error: true
        id: run-tests
        run: |
          docker build -t playwright-tests .
          docker run \
            -e CI=true \
            -e BASE_URL=${{ github.event.inputs.base_url || env.BASE_URL }} \
            -v ${{ github.workspace }}/playwright-report:/app/playwright-report \
            playwright-tests \
            npx playwright test --reporter=html,line

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Set report destination
        if: always()
        id: dest
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "path=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "path=build-${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Publish report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report
          destination_dir: ${{ steps.dest.outputs.path }}
          keep_files: true

      - name: Add report link to summary
        if: always()
        run: |
          REPORT_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}/${{ steps.dest.outputs.path }}/index.html"
          echo "## ðŸŽ­ Playwright Test Report" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **[View Report]($REPORT_URL)**" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const url = `https://${context.repo.owner}.github.io/${context.repo.repo}/${{ steps.dest.outputs.path }}/`;
            const comment = `## ðŸŽ­ Test Report\n\nðŸ“Š [View Report](${url}index.html)`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }}
            });
            
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('Test Report'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                body: comment
              });
            }

      - name: Fail if tests failed
        if: steps.run-tests.outcome == 'failure'
        run: exit 1
